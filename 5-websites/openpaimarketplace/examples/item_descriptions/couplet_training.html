<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>couplet_training</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<h1 id="couplet-training-job-template">Couplet Training Job Template</h1>
<p>This is a model training process. It uses fairseq model toolkit and a couplet dataset to train a language model. You can use different algorithms while training. The template job is use lstm.</p>
<p>Please refer <a href="https://github.com/microsoft/ai-edu/blob/master/B-%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B/B13-AI%E5%AF%B9%E8%81%94%E7%94%9F%E6%88%90%E6%A1%88%E4%BE%8B/docs/fairseq.md">this tutorial</a> for more details.</p>
<h2 id="training-data">Training Data</h2>
<p>In this job, we use <a href="https://int.openpai.org/plugin.html?index=0#/market_detail?itemId=1">Couplet Dataset</a> provided by OpenPAI Marketplace. You could also use any dataset follows fairseq model requirements.</p>
<p>The dataset is stored on Azure Blob Storage.</p>
<p>URL: <code>https://openpaimarketplace.blob.core.windows.net/marketplace/Couplet_data/couplet_data.tgz</code>).</p>
<h2 id="how-to-use">How to use</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>When use this module, you should</p>
<ol type="1">
<li><p>Load data from Azure Blob to container</p>
<pre><code>mkdir -p /data/couplet_output/
cd /data
wget &lt;% $data.uri[0] %&gt;
tar xvf couplet_data.tgz</code></pre></li>
<li><p>Set three environment variables:</p>
<pre><code>export DATA_DIR=&lt;% $data.uri[0] %&gt;
export OUTPUT_DIR=&lt;% $output.uri %&gt;
export PREPROCESSED_DATA_DIR=./preprocessed_data</code></pre></li>
<li><p>install <code>fairseq</code></p>
<pre><code>pip install fairseq==0.9.0</code></pre>
<strong>NOTE</strong>:</li>
</ol>
<ul>
<li><p>The value of <code>data</code> and <code>output</code> are defined under the <code>prerequisites</code> and <code>taskRoles</code> fileds of the YAML file on the <code>Job submission</code> page.</p></li>
<li><p><code>DATA_DIR</code>: The training data path in container, by default it uses Couplet Dataset data component. If you want to use your own datasets. First make sure mount your data into container, and then change the <code>$DATA_DIR</code> with the path.</p>
<p><em>Please view <a href="#how-to-mount">How to mount</a> to get detail information about how to mount data.</em></p></li>
<li><p><code>PREPROCESSED_DATA_DIR</code>: The path to store intermediate result, by default it is ./processed_data.</p></li>
<li><p><code>OUTPUT_DIR</code>: The path to store output result, i.e.Â the training model files.</p></li>
</ul>
<h3 id="training-command">Training command</h3>
<pre><code>fairseq-preprocess \
--source-lang up \
--target-lang down \
--trainpref ${DATA_DIR}/train \
--validpref ${DATA_DIR}/valid \
--testpref ${DATA_DIR}/test \
--destdir ${PREPROCESSED_DATA_DIR}</code></pre>
<pre><code>fairseq-train ${PREPROCESSED_DATA_DIR} \
--log-interval 100 \
--lr 0.25 \
--clip-norm 0.1 \
--dropout 0.2  \
--criterion label_smoothed_cross_entropy \
--save-dir ${OUTPUT_DIR} \
-a lstm \
--max-tokens 4000 \
--max-epoch 100</code></pre>
<h3 id="get-the-result-model">Get the result model</h3>
<p>&lt;TBD&gt;</p>
<p><br></p>
<h2 id="reference">Reference</h2>
<h3 id="how-to-mount">How to mount</h3>
<ol type="1">
<li><p>Install nfs</p>
<pre><code>$ sudo apt-get update &amp;&amp; sudo apt-get install -y nfs-common</code></pre></li>
<li><p>Upload</p>
<pre><code>$ sudo mkdir -p /mnt/nfsData
$ sudo mount &lt;container_ip&gt;:/data /mnt/nfsData
$ cp -r &lt;local_data_dir&gt; /mnt/nfsData/&lt;subPath&gt;</code></pre></li>
<li><p>Download</p>
<pre><code>$ sudo mkdir -p /mnt/nfsData
$ sudo mount &lt;container_ip&gt;:/data /mnt/nfsData
$ cp -r &lt;local_data_dir&gt; /mnt/nfsData/&lt;subPath&gt;</code></pre></li>
</ol>
</body>
</html>
