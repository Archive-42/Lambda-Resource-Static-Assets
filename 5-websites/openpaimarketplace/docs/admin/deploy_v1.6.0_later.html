<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>deploy_v1.6.0_later</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="deploy-marketplace-version-v1.6.0-and-later">Deploy Marketplace version v1.6.0 and later</h1>
<blockquote>
<p>Note: This document suits for openpaimarketplace version v1.6.0 and later, and pai version v1.6.0 and later.</p>
</blockquote>
<p>To deploy OpenPAI Marketplace, you need to prepare three parts when deploying Marketplace: database, rest server and webportal.</p>
<h2 id="deployment-in-openpai-installation">Deployment in OpenPAI Installation</h2>
<p>In OpenPAI v1.6.0 or later, admin can deploy the marketplace in OpenPAI installation step by setting <code>enable_marketplace: "true"</code> in <a href="https://openpai.readthedocs.io/en/latest/manual/cluster-admin/installation-guide.html#prepare-configuration-files"><code>config.yaml</code> file</a> under the <code>OpenPAI Customized Settings</code>.</p>
<h3 id="config.yaml-example"><code>config.yaml</code> example</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">user:</span><span class="at"> forexample</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="fu">password:</span><span class="at"> forexample</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="fu">docker_image_tag:</span><span class="at"> v1.5.0</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co"># Optional</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#######################################################################</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#                    OpenPAI Customized Settings                      #</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#######################################################################</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co"># enable_hived_scheduler: true</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co"># enable_docker_cache: false</span></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co"># docker_cache_storage_backend: &quot;azure&quot; # or &quot;filesystem&quot;</span></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="co"># docker_cache_azure_account_name: &quot;&quot;</span></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="co"># docker_cache_azure_account_key: &quot;&quot;</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co"># docker_cache_azure_container_name: &quot;dockerregistry&quot;</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co"># docker_cache_fs_mount_path: &quot;/var/lib/registry&quot;</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co"># docker_cache_remote_url: &quot;https://registry-1.docker.io&quot;</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="co"># docker_cache_htpasswd: &quot;&quot;</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="fu">enable_marketplace:</span><span class="at"> </span><span class="st">&quot;true&quot;</span></a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co"># ...</span></a></code></pre></div>
<p>Make sure the setting of <code>enable_marketplace</code> was <code>"true"</code> (include the quotation marks), and finish the <a href="https://openpai.readthedocs.io/en/latest/manual/cluster-admin/installation-guide.html">installation</a>, the marketplace should be enable by default.</p>
<h2 id="deployment-in-a-openpai-cluster">Deployment in a OpenPAI cluster</h2>
<p>When deploying in OpenPAI cluster, you should deploy 3 services: marketplace-db, marketplace-restserver and marketplace-webportal. The deployment process of these 3 services are the same as deploying other pai services (like webportal and rest-server). The documentation of how to deploy a PAI service is located in <a href="https://openpai.readthedocs.io/en/latest/manual/cluster-admin/basic-management-operations.html#pai-service-management-and-paictl">this page</a> and in <code>PAI Service Management and Paictl</code> section. Here we just figure out some main points about how to deploy these 3 marketplace services.</p>
<p>Firstly, start a dev-box and prepare a pai cluster config file <strong>service-configuration.yaml</strong> (please refer to pai doc how to get this file), and add some extra configurations in this file. Including: <code>cluster, marketplace-db, marketplace-restserver, marketplace-webportal</code> properties, the Advance settings step will give the details how to add these configs.</p>
<p>Then, push the new pai config file <strong>service-configuration.yaml</strong> to the cluster and start 3 services <code>marketplace-db marketplace-restserver marketplace-webportal</code>.</p>
<p>If the 3 services are started successfully, edit webportal plugin config in <strong>service-configuration.yaml</strong> file and push this file to cluster again and then restart pai webportal. Alternatively, if you are sure about the url of service marketplace-webportal, you could directly start OpenPAI webportal with webportal plugin config before the marketplace related services are started. When <code>marketplace-webportal</code> is started successfully, you could directly access marketplace plugin in the sidebar. Belowed are the detailed steps:</p>
<p><strong>Step 1.</strong> Set <code>cluster.common.marketplace</code> to be true in <strong>service-configuration.yaml</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">cluster:</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="fu">common:</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="fu">marketplace:</span><span class="at"> </span><span class="st">&#39;true&#39;</span></a></code></pre></div>
<p><strong>Step 2.</strong> After the pai config file <strong>service-configuration.yaml</strong> are edited correctly, push config file to update the cluster config using command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="ex">./paictl.py</span> config push -p <span class="op">&lt;</span>config-folder<span class="op">&gt;</span> -m service</a></code></pre></div>
<p><strong>Step 3.</strong> Start marketplace services in OpenPAI:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="ex">./paictl.py</span> service start -n marketplace-db marketplace-restserver marketplace-webportal</a></code></pre></div>
<p><strong>Step 4.</strong> Restart OpenPAI pylon and webportal service:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">./paictl.py</span> service stop -n pylon webportal</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="ex">./paictl.py</span> service start -n pylon webportal</a></code></pre></div>
<p><strong>Step 5.</strong> (Optional) Migrate marketplace item schema from v1.5.0 to v1.6.0</p>
<p>In OpenPAI Marketplace v1.6.0, we changed marketplace item schema to support access control for marketplace items. For user who has deployed the marketplace, marketplace database need to be migrated to new schema. Otherwise, it will throw an “SequelizeDatabaseError: column <column_name> does not exist” exception.</p>
<p>To migrate marketplace, the suggested approach is use <code>sequelize-cli</code> and <code>npx</code>, like in <code>rest_server/migrate_marketplace_item.sh</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Install dependency</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ex">npm</span> install npx sequelize-cli</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co"># Do migrate in migrations/</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="ex">npx</span> sequelize-cli db:migrate</a></code></pre></div>
<p><strong>Warning:</strong> Upgrade marketplace from previous version without changing the <code>services-configuration.yaml</code> file, the auto added marketplace item may cause duplicate marketplace tags in webportal <a href="https://github.com/microsoft/openpaimarketplace/issues/230">#230</a>. Admin can either set <code>webportal.marketplace: false</code> to avoid the auto added item, or remove the old marketplace item from <code>webportal.plugins</code> to delete the old one.</p>
<h2 id="advance-settings">Advance settings</h2>
<p>Set <code>cluster.common.marketplace: 'true'</code> will use the default settings in <code>marketplace-db marketplace-restserver marketplace-webportal</code>, and also add a default marketplace page to OpenPAI webportal. But admin can still use customized settings.</p>
<h3 id="marketplace-db-service-settings">marketplace-db service settings</h3>
<p>Admin can change marketplace-db settings in the OpenPAI config file <strong>service-configuration.yaml</strong>, all properties are optional:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">marketplace-db:</span></a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="fu">user:</span><span class="at"> &lt;username&gt;   </span><span class="co"># default is &#39;user&#39;</span></a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="fu">passwd:</span><span class="at"> &lt;password&gt; </span><span class="co"># default is &#39;passwd&#39;</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="fu">db:</span><span class="at"> marketplace    </span><span class="co"># the db name</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="fu">port:</span><span class="at"> </span><span class="dv">9291</span></a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="fu">max-connection:</span><span class="at"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="fu">data-path:</span><span class="at"> /mnt/marketplace </span><span class="co"># the data path of marketplace in master node</span></a></code></pre></div>
<h3 id="marketplace-restserver-service-settings">marketplace-restserver service settings</h3>
<p>Admin can change marketplace-restserver settings in the OpenPAI config file <strong>service-configuration.yaml</strong>, all properties are optional:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">marketplace-restserver:</span></a>
<a class="sourceLine" id="cb8-2" title="2">    <span class="fu">db_user:</span><span class="at"> &lt;username&gt;     </span><span class="co"># use the value from marketplace-db settings by default</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="fu">db_password:</span><span class="at"> &lt;password&gt; </span><span class="co"># use the value from marketplace-db settings by default</span></a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="fu">db:</span><span class="at"> marketplace         </span><span class="co"># use the value from marketplace-db settings by default</span></a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="fu">db_host:</span><span class="at"> postgres</span></a>
<a class="sourceLine" id="cb8-6" title="6">    <span class="fu">db_port:</span><span class="at"> </span><span class="dv">9291</span><span class="at">           </span><span class="co"># use the value from marketplace-db settings by default</span></a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="fu">server-port:</span><span class="at"> </span><span class="dv">9292</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="fu">idp_url:</span><span class="at"> &lt;OpenPAI rest-server url&gt; </span><span class="co"># use the value from pai rest-server settings by default</span></a>
<a class="sourceLine" id="cb8-9" title="9"></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="fu">azure_storage:</span><span class="at"> </span><span class="co"># some feature of marketplace may use azure storage to allow user upload their data, no need this by default.</span></a>
<a class="sourceLine" id="cb8-11" title="11">        <span class="fu">type:</span><span class="at"> blob</span></a>
<a class="sourceLine" id="cb8-12" title="12">        <span class="fu">storage_account:</span><span class="at"> openpaimarketplace</span></a>
<a class="sourceLine" id="cb8-13" title="13">        <span class="fu">connection_strings:</span><span class="at"> </span><span class="kw">[]</span></a>
<a class="sourceLine" id="cb8-14" title="14">        <span class="fu">azure_storage_json:</span><span class="at"> </span><span class="st">&#39;&#39;</span></a></code></pre></div>
<h3 id="marketplace-webportal-service-settings">marketplace-webportal service settings</h3>
<p>Admin can change marketplace-webportal settings in the OpenPAI config file <strong>service-configuration.yaml</strong>, all properties are optional:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">marketplace-webportal:</span></a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="fu">marketplace_api_uri:</span><span class="at"> &lt;marketplace_api_uri&gt; </span><span class="co"># use the value from marketplace-restserver settings by default</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="fu">api-port:</span><span class="at"> </span><span class="dv">9292</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="fu">server-port:</span><span class="at"> </span><span class="dv">9293</span></a></code></pre></div>
<h3 id="marketplace-service-settings">marketplace service settings</h3>
<p>Admin can change marketplace related webportal settings in the OpenPAI config file <strong>service-configuration.yaml</strong>: If don’t want to use the default marketplace plugin in OpenPAI webportal, you can set <code>webportal.marketplace: false</code> and add to <code>webportal.plugins</code> manully. If don’t need the save-template feature in OpenPAI webportal, you can set <code>webportal.save-template: false</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb10-1" title="1"><span class="fu">webportal:</span></a>
<a class="sourceLine" id="cb10-2" title="2">    <span class="fu">marketplace:</span><span class="at"> </span><span class="ch">false</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="fu">save-template:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="fu">plugins:</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="kw">-</span> <span class="fu">id:</span><span class="at"> my-marketplace</span></a>
<a class="sourceLine" id="cb10-6" title="6">        <span class="fu">title:</span><span class="at"> my-marketplace</span></a>
<a class="sourceLine" id="cb10-7" title="7">        <span class="fu">uri:</span><span class="at"> https://my-marketplace</span></a></code></pre></div>
<h2 id="notes">Notes</h2>
<ol type="1">
<li><p>The marketplace will be deployed to master node in OpenPAI cluster.</p></li>
<li><p>User can still deploy marketplaces service without set <code>cluster.common.market: "true"</code>, but the OpenPAI cluster will not expose the marketplace uri without this config.</p></li>
</ol>
<h2 id="qa">Q&amp;A</h2>
</body>
</html>
