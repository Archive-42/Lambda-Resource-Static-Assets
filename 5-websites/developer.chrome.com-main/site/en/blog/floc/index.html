<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-03-30" />
  <title>How to take part in the FLoC origin trial</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">How to take part in the FLoC origin trial</h1>
<p class="date">2021-03-30</p>
</header>
<p>Federated Learning of Cohorts (FLoC) provides a privacy-preserving mechanism for interest-based ad selection. As a user moves around the web, their browser uses the FLoC algorithm to work out its “interest cohort”, which will be the same for thousands of browsers with a similar recent browsing history. The user’s browser is associated with one interest cohort at a time and recalculates its cohort periodically (currently once every seven days during this initial origin trial) on the user’s device, without sharing individual browsing data with the browser vendor or anyone else.</p>
<p>{% Aside %} During the current FLoC origin trial, a page visit will only be included in the browser’s FLoC computation for one of two reasons: * The FLoC API (<code>document.interestCohort()</code>) is used on the page. * Chrome detects that the page <a href="https://github.com/WICG/floc/issues/82">loads ads or ads-related resources</a>.</p>
<p>For other clustering algorithms, the trial may experiment with different inclusion criteria: that’s part of the origin trial experiment process. {% endAside %}</p>
<p>To find out more about FLoC, see <a href="https://web.dev/floc">What is Federated Learning of Cohorts?</a>.</p>
<h2 id="take-part-in-a-floc-origin-trial">Take part in a FLoC origin trial</h2>
<p>An origin trial for FLoC started in Chrome 89, and has been made available as a <a href="https://web.dev/third-party-origin-trials/">third-party origin trial</a>.</p>
<p>To take part, you will need to <a href="https://developer.chrome.com/origintrials/#/view_trial/213920982300098561">register</a> for a FLoC origin trial token.</p>
<p>{% Aside %} The initial testing of FLoC is taking place with a <a href="https://blog.google/products/chrome/privacy-sustainability-and-the-importance-of-and/#jump-content:~:text=The%20initial%20testing%20of%20FLoC%20is%20taking%20place%20with%20a%20small%20percentage%20of%20users">small percentage of users</a>, and FLoC is subject to <a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md#19-are-there-any-usage-limits-on-experimental-features">origin trial usage limits</a>. This means that initially during the current trial you will only be able to access the user’s cohort (with <code>document.interestCohort()</code>) for a small proportion of visits to pages on your site that include your origin trial token. Alternatively, you can test the FLoC API locally by <a href="#enable-floc-with-browser-flags">setting browser flags</a>. {% endAside %}</p>
<h3 id="first-party-context">First-party context</h3>
<p>To access interest cohort data on your own site(s), add the origin trial token to your web pages, using one of the following methods:</p>
<ul>
<li><p>As a meta tag in the &lt;head&gt; of each page served:</p>
<p><code>&lt;meta http-equiv="origin-trial" content="TOKEN_GOES_HERE"&gt;</code></p></li>
<li><p>As an HTTP header:</p>
<p><code>Origin-Trial: TOKEN_GOES_HERE</code></p></li>
</ul>
<p>With this in place, you can try out FLoC in a first-party context: for example, to observe cohorts for visitors to your site(s).</p>
<h3 id="third-party-context">Third-party context</h3>
<p>You will need to inject the origin trial token in a meta tag in order to test the FLoC API in your code on third-party sites. <a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md#16-can-i-provide-tokens-by-running-script">Origin Trials Guide for Web Developers</a> explains how to do this.</p>
<h3 id="submit-feedback">Submit feedback</h3>
<p>Do this through Chrome’s <a href="https://developer.chrome.com/origintrials/#/trials/active">origin trial site</a>. This feedback is not public and is available only to a limited group of people on the Chrome team.<br />
When your token expires, you will get an email with a renewal link. Before renewing the token, you are again asked to submit feedback.</p>
<h2 id="try-out-floc-as-a-web-developer">Try out FLoC as a web developer</h2>
<p>There are two ways to try out FLoC during the origin trial: * Enable FLoC for your browser by setting browser flags. * Use a browser that is included in the trial.</p>
<h3 id="enable-floc-with-browser-flags">Enable FLoC with browser flags</h3>
<p>The FLoC API is very simple: just a single method that returns a promise which resolves to an object providing the cohort <code>id</code> and <code>version</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="va">document</span>.<span class="at">interestCohort</span>()</a></code></pre></div>
<p>The cohort data made available looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;14159&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;chrome.2.1&quot;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="fu">}</span></a></code></pre></div>
<p>The FLoC API is available in Chrome 89 and above, but if your browser is not included in the origin trial, you will need to run Chrome with flags in order to try out the API. <a href="http://www.chromium.org/developers/how-tos/run-chromium-with-flags">Run Chromium with flags</a> explains how to do this for different operating systems.</p>
<ol type="1">
<li><p>Start Chrome with the following flags. Make sure to copy all the text!<br> <br></p>
<pre class="text"><code>--enable-blink-features=InterestCohortAPI 
--enable-features=&quot;FederatedLearningOfCohorts:update_interval/10s/minimum_history_domain_size_required/1,FlocIdSortingLshBasedComputation,InterestCohortFeaturePolicy&quot;</code></pre>
<p><br></p></li>
<li>Check that third-party cookies are not blocked and that no ad blocker is running.</li>
<li><p>View the demo at <a href="https://floc.glitch.me/">floc.glitch.me</a> or run the following code from the DevTools console:<br><br></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="cf">await</span> <span class="va">document</span>.<span class="at">interestCohort</span>()</a></code></pre></div></li>
</ol>
<h4 id="what-do-the-experimental-flags-mean">What do the experimental flags mean?</h4>
<ul>
<li><code>InterestCohortAPI</code> enables FLoC.</li>
<li><code>update_interval/10s</code> sets the cohort to be recalculated every 10 seconds. This is only to enable testing; the cohort recalculation interval currently defaults otherwise to every seven days.</li>
<li><code>minimum_history_domain_size_required/1</code> specifies the minimum number of domains that must be available in order for the cohort to be computed. The value here is for testing only and normally would be higher.</li>
<li><code>FlocIdSortingLshBasedComputation</code> sets the clustering algorithm used by FLoC.</li>
<li><code>InterestCohortFeaturePolicy</code> enables the availability of the <a href="#how-can-websites-opt-out-of-the-floc-computation">Permissions-Policy header for FLoC</a>.</li>
<li>It is also possible to <a href="https://github.com/WICG/floc/issues/90#issuecomment-814389410">set the FLoC version</a> by using a value such as <code>"FederatedLearningOfCohorts:finch_config_version/2"</code>.</li>
</ul>
<p>You can view FLoC flag code in <a href="https://source.chromium.org/chromium/chromium/src/+/master:components/federated_learning/features/features.cc?q=minimum_history_domain_size_required&amp;ss=chromium">Chromium Code Search</a>.</p>
<p>{% Aside %} The codebase for Chrome has two different lists of features: * <code>--enable-features</code> is for Chromium browser features. * <code>--enable-blink-features</code> is for Blink.</p>
<p>You have to use the correct flag depending on which list your feature is in (though some are in both!)</p>
<p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/platform/runtime_enabled_features.json5;l=108?q=runtime_enabled_features.json5%20&amp;ss=chromium">Blink features</a> with <code>status=experimental</code> can also be enabled by using the Experimental Web Platform features flag in Chrome: chrome://flags/#enable-experimental-web-platform-features. {% endAside %}</p>
<h3 id="check-if-your-browser-is-included-in-the-origin-trial">Check if your browser is included in the origin trial</h3>
<p>During the origin trial, FLoC is enabled by default for <a href="https://blog.google/products/chrome/privacy-sustainability-and-the-importance-of-and/#jump-content:~:text=The%20initial%20testing%20of%20FLoC">a small percentage of browsers</a>. For these browsers, the FLoC API is made available without requiring flags to be set. You can check if your browser is included in the trial by trying out one of the two demos below. Each of these uses a different method to provide an origin trial token.</p>
<ul>
<li>Meta tag: <a href="https://floc-ot-meta.glitch.me">floc-ot-meta.glitch.me</a></li>
<li>HTTP header: <a href="https://floc-ot-header.glitch.me">floc-ot-header.glitch.me</a></li>
</ul>
<h2 id="try-out-floc-as-a-publisher-advertiser-or-adtech-platform">Try out FLoC as a publisher, advertiser or adtech platform</h2>
<p>The <a href="https://github.com/WICG/floc">FLoC API explainer</a> suggests use cases, but does not define how the API should be used. Different sites and services will have different constraints and requirements for using FLoC to provide relevant content and ads.</p>
<p>If you manage your own technology for content recommendations, advertising or marketing services then you could apply your FLoC insights to tailor content or marketing messages to specific cohorts. If you rely on third party companies to provide these services then it might make more sense for them to join the origin trial and run experiments including your site and other sites.</p>
<p>As an example, for a publisher finding ways to select relevant content, the process of trying out FLoC during the origin trial might work something like this:</p>
<ol type="1">
<li>Collect data about site usage and cohort IDs.</li>
<li>Analyze the data for correlations. Use the data to select relevant content.</li>
<li>Compare the FLoC approach against other mechanisms. Did it work the way you expect it?</li>
<li>Adjust the use of FLoC to select content.</li>
<li>Provide origin trial feedback.</li>
<li>Repeat.</li>
</ol>
<h2 id="how-can-websites-opt-out-of-the-floc-computation">How can websites opt out of the FLoC computation?</h2>
<p>A site should be able to declare that it does not want to be included in the user’s list of sites for cohort calculation. A new <code>interest-cohort</code> <a href="https://www.w3.org/TR/permissions-policy-1/">permissions policy</a> enables this. The policy will be <code>allow</code> by default.</p>
<p>For any frame that is <em>not</em> allowed <code>interest-cohort</code> permission, the promise returned when it calls <code>document.interestCohort()</code> will reject. If the main frame does not have <code>interest-cohort</code> permission then the page visit will not be included in interest cohort calculation.</p>
<p>For example, a site can opt out of all FLoC cohort calculation by sending the HTTP response header:</p>
<pre class="text"><code>Permissions-Policy: interest-cohort=()</code></pre>
<p>During the FLoC origin trial, pages on websites that don’t opt out will be included in the FLoC calculation if Chrome detects that they load <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/ad_tagging.md">ads-related resources</a> or if they use <code>document.interestCohort()</code>. Pages served from private IP addresses, such as intranet pages, won’t be part of the FLoC computation.</p>
<p>{% Aside %}<br />
<a href="https://chromium.googlesource.com/chromium/src/+/master/docs/ad_tagging.md">Ad Tagging in Chromium</a> explains how Chrome’s ad detection mechanism works.<br />
{% endAside %}</p>
<h3 id="why-are-pages-that-have-ads-or-ads-related-resources-included-in-floc-cohort-computation-during-the-initial-origin-trial">Why are pages that have ads or ads-related resources included in FLoC cohort computation during the initial origin trial?</h3>
<p>Origin trials give developers a chance to see what a new API proposal would be like <em>if</em> it were launched. For FLoC, how can we enable the API to be evaluated realistically before it has wide adoption? For the small-scale origin trial experiment, Chrome chose to make the assumption that every page which uses ads would use FLoC. This is unlikely to be completely realistic, but is the most plausible heuristic available.</p>
<h2 id="find-out-more">Find out more</h2>
<ul>
<li><a href="web.dev/floc">What is Federated Learning of Cohorts (FLoC)?</a></li>
<li><a href="https://web.dev/origin-trials/">Getting started with Chrome’s origin trials</a>: a basic overview.</li>
<li><a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/developer-guide.md">Origin trials guide for web developers</a>: additional technical detail and an extensive FAQ.</li>
<li><a href="https://github.com/GoogleChrome/OriginTrials/blob/gh-pages/explainer.md">Origin trial explainer</a>: motivations and design for origin trial provision, with an extensive FAQ.</li>
<li><a href="https://www.chromium.org/blink/origin-trials/running-an-origin-trial">Running an origin trial</a>: technical detail from a Chrome and Chromium perspective.</li>
<li><a href="https://www.chromium.org/blink/launching-features">Process for launching new features in Chromium</a>: how new features make their way to browser implementation.</li>
</ul>
<hr />
<p>Photo by <a href="https://unsplash.com/@rhyskentish">Rhys Kentish</a> on <a href="https://unsplash.com/photos/I5AYxsxSuVA">Unsplash</a>.</p>
</body>
</html>
