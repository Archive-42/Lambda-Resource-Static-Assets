<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2021-01-18" />
  <title>SharedArrayBuffer updates in Android Chrome 88 and Desktop Chrome 91</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">SharedArrayBuffer updates in Android Chrome 88 and Desktop Chrome 91</h1>
<p class="date">2021-01-18</p>
</header>
<p>It’s fair to say <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a> has had a bit of a rough landing on the web, but things are settling down. Here’s what you need to know:</p>
<h2 id="in-brief">In brief</h2>
<ul>
<li><code>SharedArrayBuffer</code> is currently supported in Firefox 79+, and will arrive in Android Chrome 88. However, it’s only available to pages that are <a href="#cross-origin-isolation">cross-origin isolated</a>.</li>
<li><code>SharedArrayBuffer</code> is currently available in Desktop Chrome, but from Chrome 91 it will be limited to cross-origin isolated pages. If you don’t think you can make this change in time, you can <a href="#origin-trial">register for an origin trial</a> to retain the current behavior until at least Chrome 96.</li>
<li>If you intend to enable cross-origin isolation to continue using <code>SharedArrayBuffer</code> evaluate the impact this will have on other cross-origin elements on your website, such as ad placements. Check if <code>SharedArrayBuffer</code> is used by any of your third-party resources to understand impact and guidance.</li>
</ul>
<h2 id="cross-origin-isolation-overview-cross-origin-isolation">Cross-origin isolation overview {: #cross-origin-isolation }</h2>
<p>You can make a page <em>cross-origin isolated</em> by serving the page with these headers:</p>
<pre class="http"><code>Cross-Origin-Embedder-Policy: require-corp
Cross-Origin-Opener-Policy: same-origin</code></pre>
<p>Once you do this, your page will not be able to load cross-origin content unless the resource explicitly allows it via a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cross-Origin_Resource_Policy_(CORP)"><code>Cross-Origin-Resource-Policy</code></a> header or <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> headers (<code>Access-Control-Allow-*</code> and so forth).</p>
<p>There’s also a <a href="https://web.dev/coop-coep/#observe-issues-using-the-reporting-api">reporting API</a>, so you can gather data on requests that failed as a result of <code>Cross-Origin-Embedder-Policy</code> and <code>Cross-Origin-Opener-Policy</code>.</p>
<p>If you don’t think you can make these changes in time for Chrome 91, you can <a href="#origin-trial">register for an origin trial</a> to retain current Desktop Chrome behavior until at least Chrome 96.</p>
<p>{% Aside %} <strong>Update, April 2021</strong></p>
<p>We’ve been exploring ways to deploy <code>Cross-Origin-Resource-Policy</code> at scale, as cross-origin isolation requires all subresources to explicitly opt-in. And we have come up with the idea of going in the opposite direction: a new <a href="https://github.com/mikewest/credentiallessness/">COEP “credentialless” mode</a> that allows loading resources without the CORP header by stripping all their credentials. We are figuring out the details of how it should work, but we hope this will lighten your burden of making sure the subresources are sending the <code>Cross-Origin-Resource-Policy</code> header.</p>
<p>Also, it’s known that the <code>Cross-Origin-Opener-Policy: same-origin</code> header will break integrations that require cross-origin window interactions such as OAuth and payments. To mitigate this problem, we are <a href="https://github.com/whatwg/html/issues/6364">exploring relaxing the condition</a> to enable cross-origin isolation to <code>Cross-Origin-Opener-Policy: same-origin-allow-popups</code>. This way the communication with the window opened by itself will be possible.</p>
<p>If you want to enable cross-origin isolation to use <code>SharedArrayBuffer</code> but are blocked by these challenges, we recommend <a href="#origin-trial">registering for an origin trial</a> and waiting until the new modes are available. We are not planning to terminate the origin trial until these new modes are available. {% endAside %}</p>
<p>Check out the <a href="#resources">Further reading</a> section at the bottom of this page for more guidance and information on cross-origin isolation.</p>
<h2 id="how-did-we-get-here-history">How did we get here? {: #history }</h2>
<p><code>SharedArrayBuffer</code> arrived in Chrome 60 (that’s July 2017, for those of you who think of time in dates rather than Chrome versions), and everything was great. For 6 months.</p>
<p>In January 2018 a vulnerability was revealed in some popular CPUs. See the <a href="https://googleprojectzero.blogspot.com/2018/01/reading-privileged-memory-with-side.html">announcement</a> for full details, but it essentially meant that code could use high-resolution timers to read memory that it shouldn’t have access to.</p>
<p>This was a problem for us browser vendors, as we want to allow sites to execute code in the form of JavaScript and WASM, but strictly control the memory this code can access. If you arrive on my website, I shouldn’t be able to read anything from the internet banking site you also have open. In fact, I shouldn’t even know you have your internet banking site open. These are fundamentals of web security.</p>
<p>To mitigate this, we reduced the resolution of our high-resolution timers such as <code>performance.now()</code>. However, you can <em>create</em> a high-resolution timer using <code>SharedArrayBuffer</code> by modifying memory in a tight loop in a worker, and reading it back in another thread. This couldn’t be effectively mitigated without heavily impacting well-intentioned code, so <code>SharedArrayBuffer</code> was disabled altogether.</p>
<p>A general mitigation is to ensure a webpage’s system process doesn’t contain sensitive data from elsewhere. Chrome had invested in a multi-process architecture from the start (<a href="https://www.google.com/googlebooks/chrome/big_00.html">remember the comic?</a>), but there were still cases where data from multiple sites could end up in the same process:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">&lt;iframe</span><span class="ot"> src=</span><span class="st">&quot;https://your-bank.example/balance.json&quot;</span><span class="kw">&gt;&lt;/iframe&gt;</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;https://your-bank.example/balance.json&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">&lt;link</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot"> href=</span><span class="st">&quot;https://your-bank.example/balance.json&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">&quot;https://your-bank.example/balance.json&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">&lt;video</span><span class="ot"> src=</span><span class="st">&quot;https://your-bank.example/balance.json&quot;</span><span class="kw">&gt;&lt;/video&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">&lt;!-- …and more… --&gt;</span></a></code></pre></div>
<p>These APIs have a ‘legacy’ behavior that allows content from other origins to be used without opt-in from the other origin. These requests are made with the cookies of the other origin, so it’s a full ‘logged in’ request. Nowadays, new APIs require the other origin to opt-in using <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>.</p>
<p>We worked around these legacy APIs by preventing content from entering the webpage’s process if it looked ‘incorrect’, and called it <a href="https://developers.google.com/web/updates/2018/07/site-isolation#corb">cross-origin read blocking</a>. So, in the above cases, we wouldn’t allow JSON to enter the process, as it isn’t a valid format for any of those APIs. That is, except iframes. For iframes we put the content in a different process.</p>
<p>With these mitigations in place, we reintroduced <code>SharedArrayBuffer</code> in Chrome 68 (July 2018), but only on desktop. The extra process requirements meant we couldn’t do the same on mobile devices. It was also noted that Chrome’s solution was incomplete, as we were only blocking ‘incorrect’ data formats, whereas it’s possible (although unusual) that valid CSS/JS/images at guessable URLs can contain private data.</p>
<p>Web standards folks got together to come up with a more complete cross-browser solution. The solution was to give pages a way to say “I hereby relinquish my ability to bring other-origin content into this process without their opt-in”. This declaration is done via <a href="https://web.dev/coop-coep/">COOP and COEP headers</a> served with the page. The browser enforces that, and in exchange the page gains access to <code>SharedArrayBuffer</code> and other APIs with similar powers. Other origins can opt-in to content embedding via <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cross-Origin_Resource_Policy_(CORP)"><code>Cross-Origin-Resource-Policy</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>.</p>
<p>Firefox was the first to ship <code>SharedArrayBuffer</code> with this restriction, in version 79 (July 2020).</p>
<p>Then, in January 2021, I wrote this article, and you read it. Hello.</p>
<p>And that’s where we are now. Chrome 88 brings <code>SharedArrayBuffer</code> back to Android for pages that are cross-origin isolated, and Chrome 91 brings the same requirements to desktop, both for consistency, and to achieve total cross-origin isolation.</p>
<h2 id="delaying-the-desktop-chrome-change-origin-trial">Delaying the Desktop Chrome change {: #origin-trial }</h2>
<p>This is a temporary exception in the form of an ‘origin trial’ that gives folks more time to implement cross-origin isolated pages. It enables <code>SharedArrayBuffer</code> without requiring the page to be cross-origin isolated. The exception expires in Chrome 96, and the exception only applies to Desktop Chrome.</p>
<ol type="1">
<li><a href="%7B%7Borigin_trial.url%7D%7D">Request a token</a> for your origin.</li>
<li>Add the token to your pages using an <code>Origin-Trial</code> HTTP header. The resulting response header should look something like: <code>Origin-Trial: TOKEN_GOES_HERE</code></li>
</ol>
<p>{% Aside ‘caution’ %} You can only enable the origin trial using an <code>Origin-Trial</code> HTTP header. Do not use a meta tag. {% endAside %}</p>
<p>To verify that it’s working properly, install <a href="https://www.google.com/chrome/beta/">Chrome 91 beta</a> for testing.</p>
<h2 id="further-reading-resources">Further reading {: #resources }</h2>
<ul>
<li><a href="https://web.dev/cross-origin-isolation-guide">A guide to enable cross-origin isolation</a></li>
<li><a href="https://web.dev/coop-coep/">How to cross-origin isolate your pages</a></li>
<li><a href="https://web.dev/why-coop-coep/">Why cross-origin isolation is needed</a></li>
</ul>
<p>Banner photo by <a
href="https://unsplash.com/@yeeeeeeha?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Daniel Gregoire</a> on <a
href="https://unsplash.com/s/photos/padlocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>
</body>
</html>
