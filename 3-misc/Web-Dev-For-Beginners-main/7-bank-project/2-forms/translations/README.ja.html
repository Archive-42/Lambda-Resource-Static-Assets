<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README.ja</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="バンキングアプリを作ろう-その-2-ログインと登録フォームの構築">バンキングアプリを作ろう その 2: ログインと登録フォームの構築</h1>
<h2 id="レッスン前の小テスト">レッスン前の小テスト</h2>
<p><a href="https://nice-beach-0fe9e9d0f.azurestaticapps.net/quiz/43?loc=ja">レッスン前の小テスト</a></p>
<h3 id="イントロダクション">イントロダクション</h3>
<p>最近のほとんどの Web アプリでは、アカウントを作成して自分だけのプライベート空間を持つことができます。複数のユーザーが同時に Web アプリにアクセスすることができるため、各ユーザーの個人情報を個別に保存し、どの情報を表示するかを選択する仕組みが必要になります。ここでは、<a href="https://en.wikipedia.org/wiki/Authentication">ユーザー ID を安全に管理する方法</a>については、それ自体が広範なトピックなので取り上げませんが、各ユーザーがアプリ上で1つ(または複数)の銀行口座を作成できるようにしておきます。</p>
<p>このパートでは、HTML フォームを使用して、Web アプリにログインと登録を追加します。プログラムでサーバー API にデータを送信する方法、最終的にユーザー入力の基本的な検証ルールを定義する方法を見ていきます。</p>
<h3 id="前提条件">前提条件</h3>
<p>このレッスンでは、Web アプリの <a href="../../1-template-route/translations/README.ja.md">HTML テンプレートとルーティング</a>が完了している必要があります。また、アカウントを作成するためのデータを送信できるように、ローカルに <a href="https://nodejs.org/ja">Node.js</a> と<a href="../../api/translations/README.ja.md">サーバー API を実行する</a>をインストールする必要があります。</p>
<p>ターミナルでこのコマンドを実行することで、サーバーが正常に動作していることを確認することができます。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">curl</span> http://localhost:5000/api</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co"># -&gt; 結果として &quot;Bank API v1.0.0&quot; を返す必要があります。</span></a></code></pre></div>
<hr />
<h2 id="フォームとコントロール">フォームとコントロール</h2>
<p><code>&lt;form&gt;</code> 要素は HTML ドキュメントのセクションをカプセル化し、ユーザがインタラクティブなコントロールを使ってデータを入力したり送信したりすることができます。フォームの中で利用できるユーザーインターフェイス (UI) コントロールには様々な種類がありますが、最も一般的なものは <code>&lt;input&gt;</code> と <code>&lt;button&gt;</code> 要素です。</p>
<p>例えば、ユーザがユーザ名を入力できるフィールドを作成するには、<code>&lt;input&gt;</code> 要素を使用することができます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;username&quot;</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></a></code></pre></div>
<p><code>name</code> 属性はフォームデータを送信する際のプロパティ名として使われます。<code>id</code> 属性は <code>&lt;label&gt;</code> をフォームコントロールに関連付けるために使われます。</p>
<blockquote>
<p>UI を構築する際に使用できるすべてのネイティブ UI 要素のアイデアを得るために、<a href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/input"><code>&lt;input&gt;</code> タイプ</a> と <a href="https://developer.mozilla.org/ja/docs/Learn/Forms/Other_form_controls">その他のフォームコントロール</a> のリスト全体を見てみましょう。</p>
</blockquote>
<p>✅ <code>&lt;input&gt;</code> は <a href="https://developer.mozilla.org/ja/docs/Glossary/Empty_element">空の要素</a> であることに注意してください。それは一致するクロージングタグを追加すべき<em>ではありません</em>。タグ自身で閉じる <code>&lt;input/&gt;</code> 記法を使うことはできますが、必須ではありません。</p>
<p>フォーム内の <code>&lt;button&gt;</code> 要素は少し特殊です。<code>type</code> 属性を指定しないと、ボタンが押されたときに自動的にフォームデータをサーバに送信します。以下に可能な <code>type</code> の値を示します。</p>
<ul>
<li><code>submit</code>: <code>&lt;form&gt;</code>内のデフォルトの値で、ボタンはフォームの送信アクションをトリガーします</li>
<li><code>reset</code>: ボタンはすべてのフォームコントロールを初期値にリセットします</li>
<li><code>button</code>: ボタンが押されたときのデフォルトの動作を割り当てないでください。その後、JavaScript を使ってカスタムアクションを割り当てることができます</li>
</ul>
<h3 id="タスク">タスク</h3>
<p>まずは <code>login</code> テンプレートにフォームを追加してみましょう。<em>ユーザ名</em>フィールドと<em>ログイン</em>ボタンが必要です。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">&lt;template</span><span class="ot"> id=</span><span class="st">&quot;login&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw">&lt;h1&gt;</span>Bank App<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="kw">&lt;section&gt;</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="kw">&lt;h2&gt;</span>Login<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="kw">&lt;form</span><span class="ot"> id=</span><span class="st">&quot;loginForm&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb3-6" title="6">      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;username&quot;</span><span class="kw">&gt;</span>Username<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb3-7" title="7">      <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;username&quot;</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb3-8" title="8">      <span class="kw">&lt;button&gt;</span>Login<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="kw">&lt;/section&gt;</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">&lt;/template&gt;</span></a></code></pre></div>
<p>よく見ると、ここに <code>&lt;label&gt;</code> 要素が追加されていることがわかります。<code>&lt;label&gt;</code> 要素はユーザー名フィールドなどの UI コントロールに名前を追加するために使われます。ラベルはフォームを読みやすくするために重要ですが、それだけではありません。</p>
<ul>
<li>ラベルをフォームコントロールに関連付けることで、(スクリーンリーダーのような) 支援技術を使用しているユーザーが、どのようなデータを提供することが求められているのかを理解するのに役立ちます</li>
<li>ラベルをクリックすると、関連する入力に直接フォーカスを当てることができるので、タッチスクリーンベースのデバイスでも手が届きやすくなります</li>
</ul>
<blockquote>
<p>ウェブ上の <a href="https://developer.mozilla.org/ja/docs/Learn/Accessibility/What_is_accessibility">アクセシビリティ</a> は、見落とされがちな非常に重要なトピックです。<a href="https://developer.mozilla.org/ja/docs/Learn/Accessibility/HTML">セマンティックな HTML 要素</a> のおかげで、適切に使用すれば、アクセシブルなコンテンツを作成することは難しくありません。<a href="https://developer.mozilla.org/ja/docs/Web/Accessibility">アクセシビリティについての詳細を読む</a>ことで、よくある間違いを回避し、責任ある開発者になることができます。</p>
</blockquote>
<p>あとは、前のもののすぐ下に登録用の第二形態を追加します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;hr/&gt;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">&lt;h2&gt;</span>Register<span class="kw">&lt;/h2&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">&lt;form</span><span class="ot"> id=</span><span class="st">&quot;registerForm&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;user&quot;</span><span class="kw">&gt;</span>Username<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;user&quot;</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;currency&quot;</span><span class="kw">&gt;</span>Currency<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;currency&quot;</span><span class="ot"> name=</span><span class="st">&quot;currency&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> value=</span><span class="st">&quot;$&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;description&quot;</span><span class="kw">&gt;</span>Description<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;description&quot;</span><span class="ot"> name=</span><span class="st">&quot;description&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;balance&quot;</span><span class="kw">&gt;</span>Current balance<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;balance&quot;</span><span class="ot"> name=</span><span class="st">&quot;balance&quot;</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="kw">&lt;button&gt;</span>Register<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p><code>value</code> 属性を用いて、与えられた入力に対してデフォルト値を定義することができます。 また、<code>balance</code> の入力が <code>number</code> 型であることにも注目してください。他の入力とは違うように見えますか? これを使ってみてください。</p>
<p>✅ キーボードだけでフォームをナビゲートして対話することができますか? あなたならどうしますか?</p>
<h2 id="サーバーへのデータ送信">サーバーへのデータ送信</h2>
<p>機能的な UI ができたので、次のステップはデータをサーバーに送信することです。現在のコードを使って簡単なテストをしてみましょう。<em>ログイン</em>または<em>登録</em>ボタンをクリックするとどうなりますか?</p>
<p>ブラウザの URL セクションの変化に気付きましたか？</p>
<figure>
<img src="../images/click-register.png" alt="登録ボタンをクリックした後のブラウザのURL変更のスクリーンショット" /><figcaption>登録ボタンをクリックした後のブラウザのURL変更のスクリーンショット</figcaption>
</figure>
<p><code>&lt;form&gt;</code> のデフォルトのアクションは、フォームを現在のサーバの URL に <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.3">GET メソッド</a> を使って送信し、フォームのデータを URL に直接追加することです。この方法にはいくつかの欠点があります。</p>
<ul>
<li>送信されるデータのサイズが非常に限られています (2000 文字程度)</li>
<li>データは URL で直接見ることができます (パスワードには向いていません)</li>
<li>ファイルのアップロードでは動作しません</li>
</ul>
<p>そのため、これまでの制限を受けずに、HTTP リクエストの本文でフォームデータをサーバに送信する <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">POST メソッド</a>を利用するように変更することができます。</p>
<blockquote>
<p>POST はデータを送信するために最も一般的に使用される方法ですが、<a href="https://www.w3.org/2001/tag/doc/whenToUseGet.html">いくつかの特定のシナリオ</a>では、例えば検索フィールドを実装する場合には、GET メソッドを使用することが望ましいです。</p>
</blockquote>
<h3 id="タスク-1">タスク</h3>
<p>登録フォームに <code>action</code> と <code>method</code> プロパティを追加します。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&lt;form</span><span class="ot"> id=</span><span class="st">&quot;registerForm&quot;</span><span class="ot"> action=</span><span class="st">&quot;//localhost:5000/api/accounts&quot;</span><span class="ot"> method=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></a></code></pre></div>
<p>ここで、あなたの名前で新しいアカウントを登録してみてください。<em>登録</em>ボタンをクリックすると、このような画面が表示されるはずです。</p>
<figure>
<img src="./images/form-post.png" alt="アドレス localhost:5000/api/accounts のブラウザウィンドウで、ユーザーデータを含む JSON 文字列を表示しています。" /><figcaption>アドレス localhost:5000/api/accounts のブラウザウィンドウで、ユーザーデータを含む JSON 文字列を表示しています。</figcaption>
</figure>
<p>すべてがうまくいけば、サーバーはあなたのリクエストに、作成されたアカウントデータを含む <a href="https://www.json.org/json-ja.html">JSON</a> レスポンスを返すはずです。</p>
<p>✅ 同じ名前で再度登録してみてください。どうなるでしょうか?</p>
<h2 id="ページを再読み込みせずにデータを送信する">ページを再読み込みせずにデータを送信する</h2>
<p>お気づきのように、先ほど使用したアプローチに若干の問題があります。フォームを送信するときです。これが発生するとアプリを終了し、ブラウザはサーバーの URL にリダイレクトします。<a href="https://en.wikipedia.org/wiki/Single-page_application">シングルページアプリケーション(SPA)</a> を作成しているので、ウェブアプリですべてのページのリロードを回避しようとしています。</p>
<p>ページのリロードを強制せずにフォームデータをサーバに送信するには、JavaScript のコードを使用しなければなりません。<code>&lt;form&gt;</code> 要素の <code>action</code> プロパティに URL を記述する代わりに、カスタムアクションを実行するために <code>javascript:</code> 文字列の前に任意の JavaScript コードを使用することができます。これを使うと、これまでブラウザが自動的に行っていたタスクを実装しなければならないことになります。</p>
<ul>
<li>フォームデータを取得する</li>
<li>フォームデータを適切なフォーマットに変換してエンコードする</li>
<li>HTTPリクエストを作成してサーバーに送信する</li>
</ul>
<h3 id="タスク-2">タスク</h3>
<p>登録フォームの <code>action</code> は、次のように置き換えてください。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">&lt;form</span><span class="ot"> id=</span><span class="st">&quot;registerForm&quot;</span><span class="ot"> action=</span><span class="st">&quot;javascript:register()&quot;</span><span class="kw">&gt;</span></a></code></pre></div>
<p><code>app.js</code>を開いて <code>register</code> という名前の関数を追加します。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">function</span> <span class="at">register</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="kw">const</span> registerForm <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;registerForm&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(registerForm)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="kw">const</span> data <span class="op">=</span> <span class="va">Object</span>.<span class="at">fromEntries</span>(formData)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="kw">const</span> jsonData <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="op">}</span></a></code></pre></div>
<p>ここでは、<code>getElementById()</code>を使ってフォーム要素を取得し、<a href="https://developer.mozilla.org/ja/docs/Web/API/FormData"><code>FormData</code></a> ヘルパーを使ってフォームコントロールからキーと値のペアのセットとして値を抽出します。次に、<a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/fromEntries"><code>Object.fromEntries()</code></a> を使用してデータを通常のオブジェクトに変換し、最後に Web 上でデータを交換するために一般的に使用されるフォーマットである <a href="https://www.json.org/json-ja.html">JSON</a> にデータをシリアライズします。</p>
<p>これで、データをサーバに送信する準備ができました。<code>createAccount</code> という名前の関数を新規に作成しましょう。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">createAccount</span>(account) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&#39;//localhost:5000/api/accounts&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" title="4">      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-5" title="5">      <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span> <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb8-6" title="6">      <span class="dt">body</span><span class="op">:</span> account</a>
<a class="sourceLine" id="cb8-7" title="7">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="cf">return</span> <span class="cf">await</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb8-9" title="9">  <span class="op">}</span> <span class="cf">catch</span> (error) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="cf">return</span> <span class="op">{</span> <span class="dt">error</span><span class="op">:</span> <span class="va">error</span>.<span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Unknown error&#39;</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb8-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="op">}</span></a></code></pre></div>
<p>この関数は何をしているのでしょうか？まず、ここでの <code>async</code> キーワードに注目してください。これは、この関数が <a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/async_function"><strong>非同期的に</strong></a> を実行するコードを含んでいることを意味します。await` キーワードと一緒に使用すると、非同期コードが実行されるのを待つことができます。</p>
<p>以下に、<code>async/await</code> の使用法についての簡単なビデオを示します。</p>
<p><a href="https://youtube.com/watch?v=YwmlRkrxvkk" title="Async and Await for managing promises"><img src="https://img.youtube.com/vi/YwmlRkrxvkk/0.jpg" alt="Async and Await for managing promises" /></a></p>
<p>JSON データをサーバに送信するには、<code>fetch()</code> API を使用します。このメソッドは2つのパラメータを受け取ります。</p>
<ul>
<li>サーバの URL なので、ここに <code>/localhost:5000/api/accounts</code> を返します</li>
<li>リクエストの設定。ここでメソッドを <code>POST</code> に設定し、リクエストのための <code>body</code> を提供します。JSON データをサーバに送るので、<code>Content-Type</code> ヘッダを <code>application/json</code> に設定する必要があります</li>
</ul>
<p>サーバはリクエストに対して JSON で応答するので、<code>await response.json()</code> を使って JSON の内容を解析し、結果のオブジェクトを返すことができます。このメソッドは非同期なので、返す前に <code>await</code> キーワードを使って、解析中のエラーが発生した場合にはそれもキャッチするようにしています。</p>
<p>次に、<code>register</code> 関数にコードを追加して <code>createAccount()</code> を呼び出すようにします。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">createAccount</span>(jsonData)<span class="op">;</span></a></code></pre></div>
<p>ここでは <code>await</code> キーワードを使用しているので、レジスタ関数の前に <code>async</code> キーワードを追加する必要があります。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">register</span>() <span class="op">{</span></a></code></pre></div>
<p>最後に、結果を確認するためのログを追加してみましょう。最終的な関数は以下のようになるはずです。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">register</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="kw">const</span> registerForm <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&#39;registerForm&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(registerForm)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="kw">const</span> jsonData <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(<span class="va">Object</span>.<span class="at">fromEntries</span>(formData))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">createAccount</span>(jsonData)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7">  <span class="cf">if</span> (<span class="va">result</span>.<span class="at">error</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="cf">return</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;An error occured:&#39;</span><span class="op">,</span> <span class="va">result</span>.<span class="at">error</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Account created!&#39;</span><span class="op">,</span> result)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="op">}</span></a></code></pre></div>
<p>ちょっと長かったですが、無事にたどり着きました! <a href="https://developer.mozilla.org/ja/docs/Learn/Common_questions/What_are_browser_developer_tools">ブラウザの開発者ツール</a>を開いて、新しいアカウントを登録してみると、Web ページには何も変化がないはずなのですが、コンソールにはすべてが正常に動作することを確認するメッセージが表示されます。</p>
<figure>
<img src="../images/browser-console.png" alt="ブラウザコンソールにログメッセージを表示するスクリーンショット" /><figcaption>ブラウザコンソールにログメッセージを表示するスクリーンショット</figcaption>
</figure>
<p>✅ データは安全にサーバーに送られていると思いますか? もし何者かにリクエストを傍受されたらどうしますか? 安全なデータ通信については、<a href="https://ja.wikipedia.org/wiki/HTTPS">HTTPS</a> を読むとより詳しく知ることができます。</p>
<h2 id="データの検証">データの検証</h2>
<p>最初にユーザー名を設定せずに新規アカウントを登録しようとすると、サーバーがステータスコード <a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Status/400">400 (Bad Request)</a> でエラーを返していることがわかります。</p>
<p>サーバーにデータを送信する前に、可能な限り事前に <a href="https://developer.mozilla.org/ja/docs/Learn/Forms/Form_validation">フォームデータの検証</a> を行い、有効なリクエストを送信していることを確認するのが良い方法です。HTML5 フォームコントロールは、様々な属性を使った組み込みのバリデーションを提供しています。</p>
<ul>
<li><code>required</code>: フィールドには入力する必要があります。そうでない場合は、フォームを送信することができません</li>
<li><code>minlength</code> と <code>maxlength</code>: テキストフィールドの最小文字数と最大文字数を定義します</li>
<li><code>min</code> と <code>max</code>: 数値フィールドの最小値と最大値を定義します</li>
<li><code>type</code>: <code>number</code>, <code>email</code>, <code>file</code> や <a href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/input">その他の組み込み型</a> のような、期待されるデータの種類を定義します。この属性はフォームコントロールの視覚的なレンダリングを変更することもできます</li>
<li><code>pattern</code>: これを使用すると、入力されたデータが有効かどうかをテストするための <a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Regular_Expressions">正規表現</a> パターンを定義することができます</li>
</ul>
<blockquote>
<p>ヒント: CSS 疑似クラス <code>:valid</code> と <code>:invalid</code> を利用して、フォームコントロールの見た目を有効か無効かによってカスタマイズすることができます。</p>
</blockquote>
<h3 id="タスク-3">タスク</h3>
<p>有効な新規アカウントを作成するためには、ユーザー名と通貨の2つの必須フィールドがあり、その他のフィールドは任意です。フォームの HTML を更新し、<code>required</code> 属性とフィールドのラベルのテキストの両方を使用してください。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;user&quot;</span><span class="kw">&gt;</span>Username (required)<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;user&quot;</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb12-3" title="3">...</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;currency&quot;</span><span class="kw">&gt;</span>Currency (required)<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;currency&quot;</span><span class="ot"> name=</span><span class="st">&quot;currency&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> value=</span><span class="st">&quot;$&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a></code></pre></div>
<p>このサーバの実装ではフィールドの最大長に特定の制限はありませんが、ユーザのテキスト入力に対して合理的な制限を定義することは常に良い習慣です。</p>
<p>テキストフィールドに <code>maxlength</code> 属性を追加します。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;user&quot;</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> maxlength=</span><span class="st">&quot;20&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb13-2" title="2">...</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;currency&quot;</span><span class="ot"> name=</span><span class="st">&quot;currency&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> value=</span><span class="st">&quot;$&quot;</span><span class="ot"> maxlength=</span><span class="st">&quot;5&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb13-4" title="4">...</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="kw">&lt;input</span><span class="ot"> id=</span><span class="st">&quot;description&quot;</span><span class="ot"> name=</span><span class="st">&quot;description&quot;</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> maxlength=</span><span class="st">&quot;100&quot;</span><span class="kw">&gt;</span></a></code></pre></div>
<p>これで、<em>Register</em> ボタンを押したときに、フィールドが定義したバリデーションルールに準拠していない場合は、次のように表示されるはずです。</p>
<figure>
<img src="../images/validation-error.png" alt="フォームを送信しようとしたときの検証エラーを示すスクリーンショット" /><figcaption>フォームを送信しようとしたときの検証エラーを示すスクリーンショット</figcaption>
</figure>
<p>このように、サーバにデータを送信する前に実行されるバリデーションのことを <strong>クライアントサイド</strong> のバリデーションと呼びます。しかし、データを送信せずにすべてのチェックを実行できるとは限らないことに注意してください。例えば、サーバーにリクエストを送らずに、同じユーザー名のアカウントが既に存在するかどうかを確認することはできません。サーバー上で実行される追加のバリデーションは、<strong>サーバーサイド</strong>のバリデーションと呼ばれます。</p>
<p>通常は両方を実装する必要があり、クライアントサイドのバリデーションを使用すると、ユーザーへのフィードバックを即座に提供することでユーザーエクスペリエンスが向上しますが、サーバーサイドのバリデーションは、操作するユーザーデータが健全で安全であることを確認するために非常に重要です。</p>
<hr />
<h2 id="チャレンジ">🚀 チャレンジ</h2>
<p>ユーザーが既に存在する場合には、エラーメッセージを HTML に表示します。</p>
<p>ここでは、少しのスタイリングの後に最終的なログインページがどのように見えるかの例を示します。</p>
<figure>
<img src="../images/result.png" alt="CSSスタイルを追加した後のログインページのスクリーンショット" /><figcaption>CSSスタイルを追加した後のログインページのスクリーンショット</figcaption>
</figure>
<h2 id="レッスン後の小テスト">レッスン後の小テスト</h2>
<p><a href="https://nice-beach-0fe9e9d0f.azurestaticapps.net/quiz/44?loc=ja">レッスン後の小テスト</a></p>
<h2 id="復習と自己学習">復習と自己学習</h2>
<p>開発者は、フォーム構築の取り組み、特に検証戦略に関して、非常にクリエイティブになっています。<a href="https://codepen.com">CodePen</a> を見て、さまざまなフォームの流れについて学びましょう。</p>
<h2 id="課題">課題</h2>
<p><a href="assignment.ja.md">銀行アプリのスタイル設定</a></p>
</body>
</html>
